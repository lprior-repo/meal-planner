name: NCP Daily Reconciliation

on:
  schedule:
    # Run daily at 7:00 AM CST (13:00 UTC)
    - cron: '0 13 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  reconcile:
    name: Nutrition Reconciliation
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Install dependencies
      run: go mod tidy

    - name: Build
      run: go build -o meal-planner main.go

    - name: Run NCP Sync
      env:
        CRONOMETER_USERNAME: ${{ secrets.CRONOMETER_USERNAME }}
        CRONOMETER_PASSWORD: ${{ secrets.CRONOMETER_PASSWORD }}
      run: ./meal-planner --ncp-sync --ncp-days 7

    - name: Run NCP Reconciliation
      env:
        CRONOMETER_USERNAME: ${{ secrets.CRONOMETER_USERNAME }}
        CRONOMETER_PASSWORD: ${{ secrets.CRONOMETER_PASSWORD }}
        NCP_DAILY_PROTEIN: ${{ vars.NCP_DAILY_PROTEIN || '180' }}
        NCP_DAILY_FAT: ${{ vars.NCP_DAILY_FAT || '60' }}
        NCP_DAILY_CARBS: ${{ vars.NCP_DAILY_CARBS || '250' }}
        NCP_DAILY_CALORIES: ${{ vars.NCP_DAILY_CALORIES || '2500' }}
      run: |
        echo "Running NCP Reconciliation..."
        ./meal-planner --ncp-reconcile --ncp-days 7
