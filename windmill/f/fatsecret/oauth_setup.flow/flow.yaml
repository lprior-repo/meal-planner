summary: FatSecret OAuth Setup
description: Connect your FatSecret account
value:
  modules:
    # Step 1: Get the authorization URL from FatSecret
    - id: a
      summary: Get authorization URL
      value:
        type: script
        path: f/fatsecret/oauth_start
        input_transforms:
          fatsecret:
            type: static
            value: '$res:u/admin/fatsecret_api'
          callback_url:
            type: static
            value: 'oob'

    # Step 2: Show auth link + verifier input form
    # Uses minimal TypeScript to get resume URLs (required by Windmill)
    - id: b
      summary: Authorize and enter verifier
      suspend:
        required_events: 1
        timeout: 900
        resume_form:
          schema:
            type: object
            order:
              - verifier
            properties:
              verifier:
                type: string
                title: Verifier Code
                description: After authorizing, paste the code FatSecret displays
            required:
              - verifier
      value:
        type: rawscript
        language: bun
        content: |
          import * as wmill from "windmill-client"

          export async function main(auth_url: string) {
            const urls = await wmill.getResumeUrls("user");
            return {
              resume: urls.resume,
              cancel: urls.cancel,
              description: {
                render_all: [
                  {
                    markdown: `## Authorize FatSecret

**Auth URL:** \`${auth_url}\`

[Click here to authorize](${auth_url})

After authorizing in FatSecret:
1. You'll see a verifier code displayed
2. Paste that code in the "Verifier Code" field below
3. Click "Resume" to complete the connection`
                  }
                ]
              }
            };
          }
        input_transforms:
          auth_url:
            type: javascript
            expr: results.a.auth_url

    # Step 3: Exchange verifier for access token
    # Pass the pending token from step 1 as input
    - id: c
      summary: Complete OAuth
      value:
        type: script
        path: f/fatsecret/oauth_complete
        input_transforms:
          fatsecret:
            type: static
            value: '$res:u/admin/fatsecret_api'
          oauth_token:
            type: javascript
            expr: results.a.oauth_token
          oauth_token_secret:
            type: javascript
            expr: results.a.oauth_token_secret
          oauth_verifier:
            type: javascript
            expr: resume.verifier

    # Step 4: Verify it worked by fetching profile
    # Pass the access token from step 3 as input
    - id: d
      summary: Verify connection
      value:
        type: script
        path: f/fatsecret/get_profile
        input_transforms:
          fatsecret:
            type: static
            value: '$res:u/admin/fatsecret_api'
          oauth_token:
            type: javascript
            expr: results.c.oauth_token
          oauth_token_secret:
            type: javascript
            expr: results.c.oauth_token_secret

  same_worker: false

schema:
  $schema: 'https://json-schema.org/draft/2020-12/schema'
  type: object
  properties: {}
  required: []
