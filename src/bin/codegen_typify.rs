use std::fs;
use schemars::schema::Schema;
use typify::TypeSpace;

#[derive(schemars::JsonSchema)]
#[allow(dead_code)]
struct FatSecretSchema {
    definitions: Definitions,
}

#[derive(schemars::JsonSchema)]
#[allow(dead_code)]
struct Definitions {
    date_int: i64,
    food_id: String,
    serving_id: String,
    food_entry_id: String,
    meal_type: String,
    food_type: String,
}

fn main() {
    let _schema_path = std::env::args()
        .nth(1)
        .unwrap_or("target/fatsecret_schema.json".to_string());
    let output_path = std::env::args()
        .nth(2)
        .unwrap_or("src/api/fatsecret_types.rs".to_string());
    
    let root_schema = schemars::schema_for!(FatSecretSchema);
    
    // Convert RootSchema to Schema
    let schema = Schema::Object(root_schema.schema);
    
    let settings = typify::TypeSpaceSettings::default();
    
    let mut type_space = TypeSpace::new(&settings);
    type_space.add_type(&schema).expect("Failed to add types");
    
    let types = type_space.to_stream();
    
    let mut output = String::new();
    output.push_str("// Auto-generated by typify from CUE schema\n");
    output.push_str("// Do not edit manually\n\n");
    output.push_str("use serde::{Deserialize, Serialize};\n\n");
    
    for item in types {
        output.push_str(&item.to_string());
        output.push('\n');
    }
    
    fs::write(&output_path, &output).expect("Failed to write output");
    println!("Generated {}", output_path);
}
