# https://moonrepo.dev/docs/config/project
$schema: './.moon/cache/schemas/project.json'

language: 'rust'
type: 'application'

tasks:
  # ============================================
  # Linting & Formatting (run in parallel)
  # ============================================
  fmt:
    command: 'cargo fmt --check'
    inputs:
      - 'src/**/*.rs'
      - 'tests/**/*.rs'
    options:
      cache: true

  clippy:
    command: 'cargo clippy -- -D warnings'
    inputs:
      - 'src/**/*.rs'
      - 'Cargo.toml'
      - 'Cargo.lock'
    options:
      cache: true

  validate-yaml:
    command: 'yamllint -d relaxed windmill/'
    inputs:
      - 'windmill/**/*.yaml'
    options:
      cache: true

  # ============================================
  # Testing (depends on lint passing)
  # ============================================
  test:
    command: 'cargo nextest run'
    inputs:
      - 'src/**/*.rs'
      - 'tests/**/*.rs'
      - 'Cargo.toml'
      - 'Cargo.lock'
    deps:
      - '~:fmt'
      - '~:clippy'
    options:
      cache: true

  # ============================================
  # Building
  # ============================================
  build:
    command: 'cargo build --release'
    inputs:
      - 'src/**/*.rs'
      - 'Cargo.toml'
      - 'Cargo.lock'
    outputs:
      - 'target/release/fatsecret_*'
      - 'target/release/tandoor_*'
    deps:
      - '~:test'
    options:
      cache: true

  build-dev:
    command: 'cargo build'
    inputs:
      - 'src/**/*.rs'
      - 'Cargo.toml'
      - 'Cargo.lock'
    outputs:
      - 'target/debug/fatsecret_*'
      - 'target/debug/tandoor_*'
    options:
      cache: true

  copy-binaries:
    script: 'mkdir -p bin && cp target/release/fatsecret_* target/release/tandoor_* bin/ 2>/dev/null; ls bin/'
    inputs:
      - 'target/release/fatsecret_*'
      - 'target/release/tandoor_*'
    outputs:
      - 'bin/'
    deps:
      - '~:build'

  # ============================================
  # Windmill Validation & Metadata
  # ============================================
  generate-metadata:
    script: 'cd windmill && yes | wmill script generate-metadata'
    inputs:
      - 'windmill/**/*.sh'
      - 'windmill/**/*.script.yaml'
    deps:
      - '~:validate-yaml'
    options:
      cache: true
    env:
      WMILL_WORKSPACE: 'meal-planner'

  validate-windmill:
    script: 'cd windmill && wmill sync push --dry-run --yes'
    inputs:
      - 'windmill/**/*'
    deps:
      - '~:generate-metadata'
    options:
      cache: true
    env:
      WMILL_WORKSPACE: 'meal-planner'

  # ============================================
  # Aggregate Tasks
  # ============================================
  ci:
    deps:
      # Lint tasks run in parallel (no deps between them)
      - '~:fmt'
      - '~:clippy'
      - '~:validate-yaml'
      # Then test -> build -> copy-binaries (sequential chain)
      - '~:test'
      - '~:build'
      - '~:copy-binaries'
      # Windmill validation (parallel with build chain after yaml validation)
      - '~:validate-windmill'

  quick:
    deps:
      - '~:fmt'
      - '~:clippy'
      - '~:validate-yaml'

  # ============================================
  # Deployment
  # ============================================
  deploy-binaries:
    script: |
      echo "Deploying binaries to Windmill worker..."
      # Copy binaries to Windmill worker container
      # This assumes docker-compose or k8s volume mount at /app/bin
      docker cp bin/. windmill-worker:/usr/local/bin/ 2>/dev/null || \
        echo "Note: Manual deployment needed - copy bin/* to Windmill worker /usr/local/bin/"
      ls -la bin/
    deps:
      - '~:copy-binaries'

  deploy-windmill:
    script: 'cd windmill && wmill sync push --yes'
    deps:
      - '~:validate-windmill'
    env:
      WMILL_WORKSPACE: 'meal-planner'

  deploy:
    deps:
      - '~:ci'
      - '~:deploy-binaries'
      - '~:deploy-windmill'
