# https://moonrepo.dev/docs/config/project
$schema: './.moon/cache/schemas/project.json'

language: 'rust'
layer: 'application'
stack: 'backend'

project:
  name: 'Meal Planner'
  description: 'FatSecret nutrition and Tandoor recipe integration via Windmill orchestration'

env:
  CARGO_TERM_COLOR: 'always'

fileGroups:
  sources:
    - 'src/**/*.rs'
    - 'main.rs'
  tests:
    - 'tests/**/*.rs'
  configs:
    - 'Cargo.*'
    - '.cargo/*.toml'
  windmill:
    - 'windmill/**/*.yaml'
    - 'windmill/**/*.sh'

tasks:
  # ============================================
  # Linting & Formatting
  # ============================================
  fmt:
    description: 'Check Rust formatting with cargo fmt'
    command: 'cargo fmt --check'
    inputs:
      - '@globs(sources)'
      - '@globs(tests)'
    options:
      cache: true

  clippy:
    description: 'Run Clippy with strict safety lints (forbid unsafe, deny unwrap/panic)'
    command: 'cargo clippy --all-targets --all-features -- -D warnings'
    inputs:
      - '@globs(sources)'
      - '@globs(tests)'
      - '@globs(configs)'
    options:
      cache: true

  validate-yaml:
    description: 'Validate Windmill YAML files'
    command: 'yamllint -d relaxed windmill/'
    inputs:
      - '@globs(windmill)'
    options:
      cache: true

  # ============================================
  # Testing
  # ============================================
  test:
    description: 'Run tests with cargo-nextest'
    command: 'cargo nextest run'
    inputs:
      - '@globs(sources)'
      - '@globs(tests)'
      - '@globs(configs)'
    deps:
      - '~:fmt'
      - '~:clippy'
    options:
      cache: true

  # ============================================
  # Building
  # ============================================
  build:
    description: 'Build all release binaries'
    command: 'cargo build --release'
    inputs:
      - '@globs(sources)'
      - '@globs(configs)'
    outputs:
      - 'target/release/fatsecret_*'
      - 'target/release/tandoor_*'
    deps:
      - '~:test'
    options:
      cache: true

  build-dev:
    description: 'Build debug binaries for development'
    command: 'cargo build'
    inputs:
      - '@globs(sources)'
      - '@globs(configs)'
    outputs:
      - 'target/debug/fatsecret_*'
      - 'target/debug/tandoor_*'
    options:
      cache: true

  copy-binaries:
    description: 'Copy release binaries to bin/ directory'
    script: 'mkdir -p bin && cp target/release/fatsecret_* target/release/tandoor_* bin/ 2>/dev/null; ls bin/'
    inputs:
      - 'target/release/fatsecret_*'
      - 'target/release/tandoor_*'
    outputs:
      - 'bin/'
    deps:
      - '~:build'

  # ============================================
  # Windmill
  # ============================================
  generate-metadata:
    description: 'Generate Windmill script metadata'
    script: 'cd windmill && yes | wmill script generate-metadata'
    inputs:
      - 'windmill/**/*.sh'
      - 'windmill/**/*.script.yaml'
    deps:
      - '~:validate-yaml'
    options:
      cache: true
    env:
      WMILL_WORKSPACE: 'meal-planner'

  validate-windmill:
    description: 'Dry-run Windmill sync to validate configuration'
    script: 'cd windmill && wmill sync push --dry-run --yes'
    inputs:
      - '@globs(windmill)'
    deps:
      - '~:generate-metadata'
    options:
      cache: true
    env:
      WMILL_WORKSPACE: 'meal-planner'

  # ============================================
  # Aggregate Tasks
  # ============================================
  ci:
    description: 'Full CI pipeline - lint, test, build, validate'
    deps:
      - '~:fmt'
      - '~:clippy'
      - '~:validate-yaml'
      - '~:test'
      - '~:build'
      - '~:copy-binaries'
      - '~:validate-windmill'

  quick:
    description: 'Fast lint checks for pre-commit'
    deps:
      - '~:fmt'
      - '~:clippy'
      - '~:validate-yaml'

  # ============================================
  # Deployment
  # ============================================
  deploy-binaries:
    description: 'Deploy binaries to Windmill worker'
    script: |
      echo "Deploying binaries to Windmill worker..."
      docker cp bin/. windmill-worker:/usr/local/bin/ 2>/dev/null || \
        echo "Note: Manual deployment needed - copy bin/* to Windmill worker /usr/local/bin/"
      ls -la bin/
    deps:
      - '~:copy-binaries'

  deploy-windmill:
    description: 'Push Windmill scripts and flows'
    script: 'cd windmill && wmill sync push --yes'
    deps:
      - '~:validate-windmill'
    env:
      WMILL_WORKSPACE: 'meal-planner'

  deploy:
    description: 'Full deployment - CI + deploy binaries + Windmill'
    deps:
      - '~:ci'
      - '~:deploy-binaries'
      - '~:deploy-windmill'
