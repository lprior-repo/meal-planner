# https://moonrepo.dev/docs/config/project
$schema: './.moon/cache/schemas/project.json'

language: 'rust'
layer: 'application'
stack: 'backend'

project:
  name: 'Meal Planner'
  description: 'FatSecret nutrition and Tandoor recipe integration via Windmill orchestration'

env:
  CARGO_TERM_COLOR: 'always'

fileGroups:
  sources:
    - 'src/**/*.rs'
    - 'main.rs'
  tests:
    - 'tests/**/*.rs'
  configs:
    - 'Cargo.*'
    - '.cargo/*.toml'
  windmill:
    - 'windmill/**/*.yaml'
    - 'windmill/**/*.sh'
  schemas:
    - 'schemas/cue/**/*.cue'

tasks:
  # ============================================
  # Linting & Formatting
  # ============================================
  fmt:
    description: 'Check Rust formatting with cargo fmt'
    command: 'cargo fmt --check'
    inputs:
      - '@globs(sources)'
      - '@globs(tests)'
    options:
      cache: true

  clippy:
    description: 'Run Clippy with strict safety lints (forbid unsafe, deny unwrap/panic)'
    command: 'cargo clippy --all-targets --all-features -- -D warnings'
    inputs:
      - '@globs(sources)'
      - '@globs(tests)'
      - '@globs(configs)'
    options:
      cache: true

  validate-yaml:
    description: 'Validate Windmill YAML files'
    command: 'yamllint -c .yamllintrc windmill/'
    inputs:
      - '@globs(windmill)'
    options:
      cache: true

  validate-cue:
    description: 'Validate CUE schemas and Windmill YAML contracts'
    script: |
      export PATH="/home/lewis/.local/share/mise/installs/cue/0.15.3:$PATH"
      if command -v cue >/dev/null 2>&1; then
        echo "=== CUE Schema Validation ==="
        cue vet schemas/cue/*.cue
        echo "✓ All CUE schemas valid"
        echo ""
        echo "=== Windmill YAML Contract Validation ==="
        ./scripts/validate-windmill-cue.sh
        echo ""
        echo "=== All Contracts Valid ==="
      else
        echo "WARN: CUE not installed, skipping schema validation"
        echo "Install with: mise install cue"
      fi
    inputs:
      - '@globs(schemas)'
      - '@globs(windmill)'
      - 'scripts/validate-windmill-cue.sh'
    options:
      cache: true

  # ============================================
  # API Contract Testing (Schemathesis)
  # ============================================
  test-api-contracts:
    description: 'Run Schemathesis API contract tests against OpenAPI specs'
    script: |
      echo "=== API Contract Testing with Schemathesis ==="
      echo ""
      
      # Validate FatSecret OpenAPI spec (no live API for this one)
      echo "Validating FatSecret OpenAPI spec..."
      uvx schemathesis run openapi/fatsecret.yaml --validate-schema-only
      echo "✓ FatSecret spec is valid"
      echo ""
      
      # Run limited tests against Tandoor (requires live API)
      echo "Running Tandoor API contract tests..."
      uvx schemathesis run openapi/tandoor.yaml \
        --url http://localhost:8090 \
        --checks not_a_server_error,status_code_conformance,response_schema_conformance \
        --max-failures 5 \
        --workers 2
      echo ""
      
      echo "=== API Contract Tests Complete ==="
    inputs:
      - 'openapi/*.yaml'
      - 'openapi/*.yml'
    options:
      cache: false  # Always run fresh tests against live API

  # ============================================
  # Testing
  # ============================================
  test:
    description: 'Run tests with cargo-nextest'
    command: 'cargo nextest run'
    inputs:
      - '@globs(sources)'
      - '@globs(tests)'
      - '@globs(configs)'
    deps:
      - '~:fmt'
      - '~:clippy'
      - '~:validate-cue'
    options:
      cache: true

  # ============================================
  # Building
  # ============================================
  build:
    description: 'Build all release binaries'
    command: 'cargo build --release'
    inputs:
      - '@globs(sources)'
      - '@globs(configs)'
    outputs:
      - 'target/release/fatsecret_*'
      - 'target/release/tandoor_*'
    deps:
      - '~:test'
    options:
      cache: true

  build-dev:
    description: 'Build debug binaries for development'
    command: 'cargo build'
    inputs:
      - '@globs(sources)'
      - '@globs(configs)'
    outputs:
      - 'target/debug/fatsecret_*'
      - 'target/debug/tandoor_*'
    options:
      cache: true

  dev:
    description: 'Fast development build - skip tests, just lint and build'
    command: 'cargo fmt --check && cargo clippy --all-targets --all-features -- -D warnings && cargo build --release && mkdir -p bin && cp target/release/fatsecret_* target/release/tandoor_* bin/ 2>/dev/null && echo "Built and copied binaries to bin/"'
    inputs:
      - '@globs(sources)'
      - '@globs(configs)'
    outputs:
      - 'target/release/fatsecret_*'
      - 'target/release/tandoor_*'
      - 'bin/'
    options:
      cache: true
      runInCI: false

  copy-binaries:
    description: 'Copy release binaries to bin/ directory (after full build)'
    script: 'mkdir -p bin && cp target/release/fatsecret_* target/release/tandoor_* bin/ 2>/dev/null; ls bin/ | grep -v "\.d$" | wc -l; echo "binaries copied"'
    inputs:
      - 'target/release/fatsecret_*'
      - 'target/release/tandoor_*'
    outputs:
      - 'bin/'
    deps:
      - '~:build'

  # ============================================
  # Windmill
  # ============================================
  generate-metadata:
    description: 'Generate Windmill script metadata (skip in CI - too slow)'
    script: 'echo "Skipping generate-metadata in CI - run manually with: cd windmill && wmill script generate-metadata"'
    inputs:
      - 'windmill/**/*.sh'
      - 'windmill/**/*.script.yaml'
    deps:
      - '~:validate-yaml'
    options:
      cache: true
    env:
      WMILL_WORKSPACE: 'meal-planner'

  validate-windmill:
    description: 'Validate Windmill YAML structure (fast local check)'
    script: |
      echo "Validating Windmill script structure..."
      # Check all script.yaml files have required fields
      for f in windmill/f/**/*.script.yaml; do
        if [ -f "$f" ]; then
          if ! grep -q "^language:" "$f"; then
            echo "ERROR: $f missing 'language' field"
            exit 1
          fi
          if ! grep -q "^kind:" "$f"; then
            echo "ERROR: $f missing 'kind' field"
            exit 1
          fi
        fi
      done
      echo "All Windmill scripts valid"
    inputs:
      - '@globs(windmill)'
    deps:
      - '~:validate-yaml'
    options:
      cache: true

  # ============================================
  # Aggregate Tasks
  # ============================================
  ci:
    description: 'Full CI pipeline - lint, test, build, validate'
    deps:
      - '~:fmt'
      - '~:clippy'
      - '~:validate-yaml'
      - '~:validate-cue'
      - '~:test'
      - '~:build'
      - '~:copy-binaries'
      - '~:validate-windmill'

  quick:
    description: 'Fast lint checks for pre-commit'
    deps:
      - '~:fmt'
      - '~:clippy'
      - '~:validate-yaml'
      - '~:validate-cue'

  # ============================================
  # Deployment
  # ============================================
  deploy-binaries:
    description: 'Deploy binaries to Windmill worker'
    script: |
      echo "Deploying binaries to Windmill worker..."
      docker cp bin/. windmill-worker:/usr/local/bin/ 2>/dev/null || \
        echo "Note: Manual deployment needed - copy bin/* to Windmill worker /usr/local/bin/"
      ls -la bin/
    deps:
      - '~:copy-binaries'

  deploy-windmill:
    description: 'Push Windmill scripts and flows'
    script: 'cd windmill && wmill sync push --yes'
    deps:
      - '~:validate-windmill'
    env:
      WMILL_WORKSPACE: 'meal-planner'

  deploy:
    description: 'Full deployment - CI + deploy binaries + Windmill'
    deps:
      - '~:ci'
      - '~:deploy-binaries'
      - '~:deploy-windmill'
