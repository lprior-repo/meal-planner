--- /home/lewis/src/meal-planner/server/src/server/web.gleam
+++ /home/lewis/src/meal-planner/server/src/server/web.gleam
@@ -18,6 +18,7 @@
 import wisp
 import wisp/wisp_mist

+import server/meal_logging
 import server/storage
 import shared/types

@@ -80,6 +81,8 @@
     ["recipes", id] -> recipe_detail_page(id)
     ["dashboard"] -> dashboard_page()
     ["profile"] -> profile_page()
+    ["log"] -> meal_logging.log_meal_page()
+    ["log", id] -> meal_logging.log_meal_form(id)

     // 404
     _ -> not_found_page()
@@ -297,7 +300,7 @@
       ]),
       // Quick actions
       html.div([attribute.class("quick-actions")], [
-        html.a([attribute.href("/recipes"), attribute.class("btn")], [
+        html.a([attribute.href("/log"), attribute.class("btn")], [
           element.text("Add Meal"),
         ]),
       ]),
@@ -432,10 +435,11 @@
 fn handle_api(req: wisp.Request, path: List(String)) -> wisp.Response {
   case path {
     ["recipes"] -> api_recipes(req)
     ["recipes", id] -> api_recipe(req, id)
     ["profile"] -> api_profile(req)
     ["logs", date] -> api_logs(req, date)
-    ["logs"] -> api_logs_endpoint(req)
+    ["logs", "create"] -> api_create_log(req)
     _ -> wisp.not_found()
   }
 }
@@ -480,6 +484,64 @@
   let json_data = types.daily_log_to_json(log)
   wisp.json_response(json.to_string(json_data), 200)
 }
+
+fn api_create_log(req: wisp.Request) -> wisp.Response {
+  use formdata <- wisp.require_form(req)
+
+  // Extract form parameters
+  let recipe_id = case list.key_find(formdata.values, "recipe_id") {
+    Ok(id) -> id
+    Error(_) -> ""
+  }
+
+  let servings =
+    case list.key_find(formdata.values, "servings") {
+      Ok(s) ->
+        case float.parse(s) {
+          Ok(f) -> f
+          Error(_) -> 1.0
+        }
+      Error(_) -> 1.0
+    }
+
+  let meal_type_str = case list.key_find(formdata.values, "meal_type") {
+    Ok(mt) -> mt
+    Error(_) -> "snack"
+  }
+
+  let meal_type = case meal_type_str {
+    "breakfast" -> types.Breakfast
+    "lunch" -> types.Lunch
+    "dinner" -> types.Dinner
+    _ -> types.Snack
+  }
+
+  let date = case list.key_find(formdata.values, "date") {
+    Ok(d) -> d
+    Error(_) -> get_today_date()
+  }
+
+  // Save to database
+  use conn <- storage.with_connection(storage.db_path)
+  case storage.get_recipe_by_id(conn, recipe_id) {
+    Error(_) -> wisp.redirect("/dashboard")
+    Ok(recipe) -> {
+      let scaled_macros = types.macros_scale(recipe.macros, servings)
+      let entry =
+        types.FoodLogEntry(
+          id: generate_id(),
+          recipe_id: recipe_id,
+          recipe_name: recipe.name,
+          servings: servings,
+          macros: scaled_macros,
+          meal_type: meal_type,
+          logged_at: current_timestamp(),
+        )
+
+      case storage.save_food_log_entry(conn, date, entry) {
+        Ok(_) -> wisp.redirect("/dashboard")
+        Error(_) -> wisp.redirect("/dashboard")
+      }
+    }
+  }
+}
+
+fn get_today_date() -> String {
+  let #(#(year, month, day), _) = erlang_local_time()
+  int.to_string(year)
+  <> "-"
+  <> pad_int(month)
+  <> "-"
+  <> pad_int(day)
+}
+
+fn pad_int(i: Int) -> String {
+  let s = int.to_string(i)
+  case i < 10 {
+    True -> "0" <> s
+    False -> s
+  }
+}
+
+@external(erlang, "calendar", "local_time")
+fn erlang_local_time() -> #(#(Int, Int, Int), #(Int, Int, Int))
