#!/bin/sh
# bd-hooks-version: 0.28.0
#
# pre-commit hook - Code Quality Gates
#
# This hook prevents committing code that fails quality checks:
# 1. Beads JSONL sync (ensure tasks are up to date)
# 2. Gleam format (ensure code is formatted)
# 3. Gleam build (ensure code compiles)
# 4. Gleam test (ensure tests pass)
#
# Can be bypassed with: git commit --no-verify
# But post-commit will warn, and pre-push will block!
#
# Installation:
#   cp examples/git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use the install script:
#   examples/git-hooks/install.sh

set -e

# Gleam project is at root
GLEAM_DIR="."

echo "ðŸ” Running pre-commit quality gates..."

# ============================================================================
# Step 1: Beads sync (if available)
# ============================================================================

if [ -d .beads ] && command -v bd >/dev/null 2>&1; then
    echo "  â€¢ Syncing Beads JSONL..."
    if bd sync --flush-only >/dev/null 2>&1; then
        echo "    âœ“ Beads synced"
    else
        echo "    âš  Beads sync skipped (daemon not running)"
    fi
fi

# ============================================================================
# Step 2: Check code formatting (gleam format)
# ============================================================================

echo "  â€¢ Checking code formatting..."
cd "$GLEAM_DIR"

if ! gleam format --check >/dev/null 2>&1; then
    echo "    âœ— Code formatting failed!"
    echo ""
    echo "    Fix formatting with:"
    echo "      gleam format"
    echo ""
    cd - >/dev/null 2>&1 || exit 1
    exit 1
fi
echo "    âœ“ Code formatting OK"

# ============================================================================
# Step 3: Check build compilation (gleam build)
# ============================================================================

echo "  â€¢ Checking Erlang build..."
if ! gleam build --target erlang 2>&1 | tee /tmp/gleam_build_erlang.log >/dev/null; then
    echo "    âœ— Erlang build failed!"
    echo ""
    echo "    Build errors:"
    tail -20 /tmp/gleam_build_erlang.log | sed 's/^/      /'
    echo ""
    echo "    Fix the errors above and try committing again."
    echo ""
    cd - >/dev/null 2>&1 || exit 1
    exit 1
fi
echo "    âœ“ Erlang build OK"

# ============================================================================
# Step 4: Run tests (gleam test)
# ============================================================================

echo "  â€¢ Running tests..."
if ! gleam test 2>&1 | tee /tmp/gleam_test.log >/dev/null; then
    echo "    âœ— Tests failed!"
    echo ""
    echo "    Test failures:"
    tail -30 /tmp/gleam_test.log | sed 's/^/      /'
    echo ""
    echo "    Fix the failing tests and try committing again."
    echo ""
    cd - >/dev/null 2>&1 || exit 1
    exit 1
fi
echo "    âœ“ Tests passed"

cd - >/dev/null 2>&1 || exit 1

# ============================================================================
# All checks passed!
# ============================================================================

echo ""
echo "âœ… All quality gates passed! Proceeding with commit..."
echo ""

exit 0
