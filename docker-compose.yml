version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: meal-planner-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      # Multiple databases will be created via init script
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Tandoor Recipes (Recipe Management System)
  tandoor:
    image: vabene1111/recipes:latest
    container_name: meal-planner-tandoor
    restart: unless-stopped
    network_mode: "host"
    environment:
      # Database Configuration
      DB_ENGINE: django.db.backends.postgresql
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DB: tandoor
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}

      # Tandoor Configuration
      SECRET_KEY: ${TANDOOR_SECRET_KEY:-changeme-insecure-key-for-dev}
      TIMEZONE: America/New_York

      # API & Features
      ENABLE_PDF_EXPORT: 1
      ENABLE_SIGNUP: 1
      GUNICORN_MEDIA: 0

      # URLs
      SCRIPT_NAME: ""

    volumes:
      - tandoor_static:/opt/recipes/staticfiles
      - tandoor_media:/opt/recipes/mediafiles
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Gleam Backend (AI Meal Planning + Macro Calculations)
  # Note: This will be built from source once the Gleam HTTP server is implemented
  gleam-backend:
    build:
      context: ./gleam
      dockerfile: Dockerfile
    container_name: meal-planner-gleam
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      # Database Configuration
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: meal_planner
      DATABASE_USER: postgres
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      DATABASE_POOL_SIZE: 10

      # Server Configuration
      PORT: 8080
      ENVIRONMENT: production

      # Tandoor Integration
      TANDOOR_BASE_URL: http://tandoor:8000

    volumes:
      - ./gleam:/app
    # Uncomment when Gleam HTTP server is ready
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3

volumes:
  postgres_data:
    driver: local
  tandoor_static:
    driver: local
  tandoor_media:
    driver: local

networks:
  default:
    name: meal-planner-network
