/// FatSecret Profile API Tests - POST /api/fatsecret/profile and GET /api/fatsecret/profile/auth
///
/// This test module covers:
/// - POST /api/fatsecret/profile - Create a new FatSecret profile
/// - GET /api/fatsecret/profile/auth - Get profile authentication credentials
///
/// These endpoints require 3-legged OAuth authentication.
/// The tests use mocking to simulate FatSecret API responses.
///
/// Run with: gleam test
import gleam/dict
import gleam/json
import gleam/option.{None, Some}
import gleam/string
import gleeunit
import gleeunit/should
import meal_planner/fatsecret/profile/types.{
  Profile, ProfileAuth, ProfileCreateInput,
}
import meal_planner/fatsecret/profile/decoders

// ============================================================================
// Test Suite Entry Point
// ============================================================================

pub fn main() {
  gleeunit.main()
}

// ============================================================================
// Tests: Profile Decoding (Foundation for API Response Handling)
// ============================================================================

/// Test: Profile decoder handles full profile response
pub fn profile_decoder_full_profile_test() {
  let json_str = json.object([
    #("goal_weight_kg", json.float(75.5)),
    #("last_weight_kg", json.float(80.2)),
    #("last_weight_date_int", json.int(20251214)),
    #("last_weight_comment", json.string("Woohoo!")),
    #("height_cm", json.float(175.0)),
    #("calorie_goal", json.int(2000)),
    #("weight_measure", json.string("Kg")),
    #("height_measure", json.string("Cm")),
  ])
  |> json.to_string

  let decoder = decoders.profile_decoder()
  let result = json.parse(json_str, decoder)

  should.be_ok(result)
  let assert Ok(Profile(
    goal_weight_kg: Some(goal_weight),
    last_weight_kg: Some(last_weight),
    last_weight_date_int: Some(date),
    last_weight_comment: Some(comment),
    height_cm: Some(height),
    calorie_goal: Some(calories),
    weight_measure: Some(weight_unit),
    height_measure: Some(height_unit),
  )) = result

  should.equal(goal_weight, 75.5)
  should.equal(last_weight, 80.2)
  should.equal(date, 20251214)
  should.equal(comment, "Woohoo!")
  should.equal(height, 175.0)
  should.equal(calories, 2000)
  should.equal(weight_unit, "Kg")
  should.equal(height_unit, "Cm")
}

/// Test: Profile decoder handles partial profile response
pub fn profile_decoder_partial_profile_test() {
  let json_str = json.object([
    #("goal_weight_kg", json.float(75.5)),
    #("last_weight_kg", json.null()),
    #("last_weight_date_int", json.null()),
    #("last_weight_comment", json.null()),
    #("height_cm", json.float(175.0)),
    #("calorie_goal", json.int(2000)),
    #("weight_measure", json.string("Kg")),
    #("height_measure", json.string("Cm")),
  ])
  |> json.to_string

  let decoder = decoders.profile_decoder()
  let result = json.parse(json_str, decoder)

  should.be_ok(result)
  let assert Ok(Profile(
    goal_weight_kg: Some(goal_weight),
    last_weight_kg: None,
    last_weight_date_int: None,
    last_weight_comment: None,
    height_cm: Some(height),
    calorie_goal: Some(calories),
    weight_measure: Some(weight_unit),
    height_measure: Some(height_unit),
  )) = result

  should.equal(goal_weight, 75.5)
  should.equal(height, 175.0)
  should.equal(calories, 2000)
  should.equal(weight_unit, "Kg")
  should.equal(height_unit, "Cm")
}

/// Test: Profile decoder handles completely null profile
pub fn profile_decoder_empty_profile_test() {
  let json_str = json.object([
    #("goal_weight_kg", json.null()),
    #("last_weight_kg", json.null()),
    #("last_weight_date_int", json.null()),
    #("last_weight_comment", json.null()),
    #("height_cm", json.null()),
    #("calorie_goal", json.null()),
    #("weight_measure", json.null()),
    #("height_measure", json.null()),
  ])
  |> json.to_string

  let decoder = decoders.profile_decoder()
  let result = json.parse(json_str, decoder)

  should.be_ok(result)
  let assert Ok(Profile(
    goal_weight_kg: None,
    last_weight_kg: None,
    last_weight_date_int: None,
    last_weight_comment: None,
    height_cm: None,
    calorie_goal: None,
    weight_measure: None,
    height_measure: None,
  )) = result
}

/// Test: Profile response decoder unwraps profile field
pub fn profile_response_decoder_unwraps_field_test() {
  let json_str = json.object([
    #("profile", json.object([
      #("goal_weight_kg", json.float(75.5)),
      #("last_weight_kg", json.float(80.2)),
      #("last_weight_date_int", json.int(20251214)),
      #("last_weight_comment", json.string("Woohoo!")),
      #("height_cm", json.float(175.0)),
      #("calorie_goal", json.int(2000)),
      #("weight_measure", json.string("Kg")),
      #("height_measure", json.string("Cm")),
    ])),
  ])
  |> json.to_string

  let decoder = decoders.profile_response_decoder()
  let result = json.parse(json_str, decoder)

  should.be_ok(result)
  let assert Ok(Profile(
    goal_weight_kg: Some(goal_weight),
    last_weight_kg: Some(last_weight),
    last_weight_date_int: _,
    last_weight_comment: _,
    height_cm: Some(height),
    calorie_goal: Some(calories),
    weight_measure: _,
    height_measure: _,
  )) = result

  should.equal(goal_weight, 75.5)
  should.equal(last_weight, 80.2)
  should.equal(height, 175.0)
  should.equal(calories, 2000)
}

// ============================================================================
// Tests: Profile Auth Decoding (For POST /api/fatsecret/profile)
// ============================================================================

/// Test: Profile auth decoder handles valid auth response
pub fn profile_auth_decoder_valid_auth_test() {
  let json_str = json.object([
    #("auth_token", json.string("639aa3c886b849d2811c09bb640ec2b3")),
    #("auth_secret", json.string("cadff7ef247744b4bff48fb2489451fc")),
  ])
  |> json.to_string

  let decoder = decoders.profile_auth_decoder()
  let result = json.parse(json_str, decoder)

  should.be_ok(result)
  let assert Ok(ProfileAuth(
    auth_token: token,
    auth_secret: secret,
  )) = result

  should.equal(token, "639aa3c886b849d2811c09bb640ec2b3")
  should.equal(secret, "cadff7ef247744b4bff48fb2489451fc")
}

/// Test: Profile auth response decoder unwraps profile field
pub fn profile_auth_response_decoder_unwraps_field_test() {
  let json_str = json.object([
    #("profile", json.object([
      #("auth_token", json.string("639aa3c886b849d2811c09bb640ec2b3")),
      #("auth_secret", json.string("cadff7ef247744b4bff48fb2489451fc")),
    ])),
  ])
  |> json.to_string

  let decoder = decoders.profile_auth_response_decoder()
  let result = json.parse(json_str, decoder)

  should.be_ok(result)
  let assert Ok(ProfileAuth(
    auth_token: token,
    auth_secret: secret,
  )) = result

  should.equal(token, "639aa3c886b849d2811c09bb640ec2b3")
  should.equal(secret, "cadff7ef247744b4bff48fb2489451fc")
}

/// Test: Profile auth decoder fails with missing fields
pub fn profile_auth_decoder_missing_fields_test() {
  let json_str = json.object([
    #("auth_token", json.string("639aa3c886b849d2811c09bb640ec2b3")),
    // Missing auth_secret
  ])
  |> json.to_string

  let decoder = decoders.profile_auth_decoder()
  let result = json.parse(json_str, decoder)

  should.be_error(result)
}

// ============================================================================
// Tests: Profile Types and Constructors
// ============================================================================

/// Test: Create ProfileCreateInput
pub fn profile_create_input_test() {
  let input = ProfileCreateInput(user_id: "user-12345")
  should.equal(input.user_id, "user-12345")
}

/// Test: Create ProfileAuth
pub fn profile_auth_creation_test() {
  let auth = ProfileAuth(
    auth_token: "token-xyz",
    auth_secret: "secret-abc",
  )

  should.equal(auth.auth_token, "token-xyz")
  should.equal(auth.auth_secret, "secret-abc")
}

/// Test: Create Profile with all fields
pub fn profile_creation_all_fields_test() {
  let profile = Profile(
    goal_weight_kg: Some(75.5),
    last_weight_kg: Some(80.2),
    last_weight_date_int: Some(20251214),
    last_weight_comment: Some("Good progress!"),
    height_cm: Some(175.0),
    calorie_goal: Some(2000),
    weight_measure: Some("Kg"),
    height_measure: Some("Cm"),
  )

  should.equal(profile.goal_weight_kg, Some(75.5))
  should.equal(profile.last_weight_kg, Some(80.2))
  should.equal(profile.last_weight_date_int, Some(20251214))
  should.equal(profile.last_weight_comment, Some("Good progress!"))
  should.equal(profile.height_cm, Some(175.0))
  should.equal(profile.calorie_goal, Some(2000))
  should.equal(profile.weight_measure, Some("Kg"))
  should.equal(profile.height_measure, Some("Cm"))
}

/// Test: Create Profile with None fields
pub fn profile_creation_empty_fields_test() {
  let profile = Profile(
    goal_weight_kg: None,
    last_weight_kg: None,
    last_weight_date_int: None,
    last_weight_comment: None,
    height_cm: None,
    calorie_goal: None,
    weight_measure: None,
    height_measure: None,
  )

  should.equal(profile.goal_weight_kg, None)
  should.equal(profile.last_weight_kg, None)
  should.equal(profile.height_cm, None)
  should.equal(profile.calorie_goal, None)
}

// ============================================================================
// Tests: JSON Serialization (For Request Building)
// ============================================================================

/// Test: Serialize profile create input to JSON
pub fn serialize_profile_create_input_test() {
  let input = ProfileCreateInput(user_id: "user-12345")

  // Construct JSON as it would be sent to API
  let json_obj = json.object([
    #("user_id", json.string(input.user_id)),
  ])

  let json_str = json.to_string(json_obj)

  // Should be valid JSON
  should.be_true(string.length(json_str) > 0)
}

/// Test: Build profile get auth request parameters
pub fn build_profile_get_auth_request_test() {
  let user_id = "user-12345"

  // FatSecret API expects user_id parameter
  let params = dict.new()
  |> dict.insert("user_id", user_id)

  should.equal(dict.get(params, "user_id"), Ok(user_id))
  should.equal(dict.size(params), 1)
}

// ============================================================================
// Tests: Option Handling Patterns
// ============================================================================

/// Test: Option pattern matching on Profile fields
pub fn profile_option_matching_test() {
  let profile = Profile(
    goal_weight_kg: Some(75.5),
    last_weight_kg: None,
    last_weight_date_int: Some(20251214),
    last_weight_comment: None,
    height_cm: Some(175.0),
    calorie_goal: Some(2000),
    weight_measure: Some("Kg"),
    height_measure: Some("Cm"),
  )

  // Count how many fields have values
  let has_goal = case profile.goal_weight_kg {
    Some(_) -> 1
    None -> 0
  }

  let has_last_weight = case profile.last_weight_kg {
    Some(_) -> 1
    None -> 0
  }

  let has_height = case profile.height_cm {
    Some(_) -> 1
    None -> 0
  }

  let total_set_fields = has_goal + has_last_weight + has_height

  should.equal(has_goal, 1)
  should.equal(has_last_weight, 0)
  should.equal(has_height, 1)
  should.be_true(total_set_fields >= 2)
}

/// Test: Extract values from optional profile fields
pub fn extract_optional_profile_values_test() {
  let profile = Profile(
    goal_weight_kg: Some(75.5),
    last_weight_kg: None,
    last_weight_date_int: Some(20251214),
    last_weight_comment: Some("Good!"),
    height_cm: Some(175.0),
    calorie_goal: None,
    weight_measure: Some("Kg"),
    height_measure: Some("Cm"),
  )

  // Use option.unwrap or case statement
  let goal_weight = case profile.goal_weight_kg {
    Some(w) -> w
    None -> 0.0
  }
  let last_weight = case profile.last_weight_kg {
    Some(w) -> w
    None -> 0.0
  }
  let height = case profile.height_cm {
    Some(h) -> h
    None -> 0.0
  }

  should.equal(goal_weight, 75.5)
  should.equal(last_weight, 0.0)
  should.equal(height, 175.0)
}

// ============================================================================
// Tests: Response Format Validation (API Contract Tests)
// ============================================================================

/// Test: FatSecret profile response has correct structure
pub fn fatsecret_profile_response_structure_test() {
  let response_json = json.object([
    #("profile", json.object([
      #("goal_weight_kg", json.float(75.5)),
      #("last_weight_kg", json.float(80.2)),
      #("last_weight_date_int", json.int(20251214)),
      #("last_weight_comment", json.string("Woohoo!")),
      #("height_cm", json.float(175.0)),
      #("calorie_goal", json.int(2000)),
      #("weight_measure", json.string("Kg")),
      #("height_measure", json.string("Cm")),
    ])),
  ])

  let json_str = json.to_string(response_json)

  // Verify JSON is well-formed
  should.be_ok(json.parse(json_str, decoders.profile_response_decoder()))
}

/// Test: FatSecret profile auth response has correct structure
pub fn fatsecret_profile_auth_response_structure_test() {
  let response_json = json.object([
    #("profile", json.object([
      #("auth_token", json.string("639aa3c886b849d2811c09bb640ec2b3")),
      #("auth_secret", json.string("cadff7ef247744b4bff48fb2489451fc")),
    ])),
  ])

  let json_str = json.to_string(response_json)

  // Verify JSON is well-formed
  should.be_ok(json.parse(json_str, decoders.profile_auth_response_decoder()))
}

// ============================================================================
// Tests: Error Handling Patterns
// ============================================================================

/// Test: Handle malformed JSON in profile response
pub fn handle_malformed_profile_json_test() {
  let malformed_json = "{ invalid json"

  let decoder = decoders.profile_response_decoder()
  let result = json.parse(malformed_json, decoder)

  should.be_error(result)
}

/// Test: Handle missing required auth fields
pub fn handle_missing_auth_fields_test() {
  let json_str = json.object([
    #("profile", json.object([
      #("auth_token", json.string("token-xyz")),
      // Missing auth_secret
    ])),
  ])
  |> json.to_string

  let decoder = decoders.profile_auth_response_decoder()
  let result = json.parse(json_str, decoder)

  should.be_error(result)
}

/// Test: Handle wrong types in profile response
pub fn handle_wrong_type_in_profile_test() {
  let json_str = json.object([
    #("goal_weight_kg", json.string("not a number")),
    #("last_weight_kg", json.null()),
    #("last_weight_date_int", json.null()),
    #("last_weight_comment", json.null()),
    #("height_cm", json.null()),
    #("calorie_goal", json.null()),
    #("weight_measure", json.null()),
    #("height_measure", json.null()),
  ])
  |> json.to_string

  let decoder = decoders.profile_decoder()
  let result = json.parse(json_str, decoder)

  should.be_error(result)
}
