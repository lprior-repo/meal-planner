/// Comprehensive test suite for meal_planner/storage module
/// Following TDD principles and Martin Fowler's testing approach
///
/// Test Categories:
/// 1. Unit Tests - Test individual functions in isolation
/// 2. Integration Tests - Test database operations with test DB
/// 3. Edge Cases - Boundary conditions and error handling
/// 4. Error Paths - Explicit error scenario testing
///
/// Test Naming Convention: module_function_scenario_expected_result
import gleam/list
import gleam/option.{None, Some}
import gleeunit
import gleeunit/should
import meal_planner/ncp
import meal_planner/storage
import meal_planner/types.{
  type Recipe, Active, Breakfast, Dinner, Gain, High, Ingredient, Lose, Low,
  Lunch, Macros, Maintain, Medium, Moderate, Recipe, Sedentary, Snack,
  UserProfile,
}
import test_db

pub fn main() {
  gleeunit.main()
}

// ============================================================================
// Configuration Tests
// ============================================================================

pub fn storage_default_config_returns_valid_config_test() {
  let config = storage.default_config()

  config.host
  |> should.equal("localhost")

  config.port
  |> should.equal(5432)

  config.database
  |> should.equal("meal_planner")

  config.user
  |> should.equal("postgres")

  config.password
  |> should.equal(Some("postgres"))

  config.pool_size
  |> should.equal(10)
}

pub fn storage_default_config_has_positive_pool_size_test() {
  let config = storage.default_config()

  config.pool_size
  |> should.be_true(fn(size) { size > 0 })
}

// ============================================================================
// Database Connection Tests
// ============================================================================

pub fn storage_start_pool_connects_successfully_test() {
  let config = test_db.test_config()

  case storage.start_pool(config) {
    Ok(_conn) -> {
      // Success - connection established
      Nil
    }
    Error(msg) -> {
      // Skip test if database not available
      case msg {
        "Database connection timeout" -> Nil
        "Database connection failed: " <> _ -> Nil
        _ -> should.fail()
      }
    }
  }
}

// ============================================================================
// Nutrition State Storage Tests
// ============================================================================

pub fn storage_save_nutrition_state_valid_data_succeeds_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let state =
        ncp.NutritionState(
          date: "2025-12-03",
          consumed: ncp.NutritionData(
            protein: 150.0,
            fat: 60.0,
            carbs: 200.0,
            calories: 1940.0,
          ),
          synced_at: "2025-12-03T10:00:00Z",
        )

      case storage.save_nutrition_state(conn, state) {
        Ok(_) -> {
          // Verify it was saved by retrieving it
          case storage.get_nutrition_state(conn, "2025-12-03") {
            Ok(retrieved) -> {
              retrieved.date
              |> should.equal("2025-12-03")
              retrieved.consumed.protein
              |> should.equal(150.0)
              retrieved.consumed.fat
              |> should.equal(60.0)
            }
            Error(_) -> should.fail()
          }
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_nutrition_state_nonexistent_date_returns_not_found_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.get_nutrition_state(conn, "1999-01-01") {
        Error(storage.NotFound) -> Nil
        Error(_) -> should.fail()
        Ok(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_nutrition_history_returns_ordered_list_test() {
  case test_db.setup() {
    Ok(conn) -> {
      // Save multiple states
      let state1 =
        ncp.NutritionState(
          date: "2025-12-01",
          consumed: ncp.NutritionData(
            protein: 100.0,
            fat: 50.0,
            carbs: 150.0,
            calories: 1450.0,
          ),
          synced_at: "2025-12-01T10:00:00Z",
        )

      let state2 =
        ncp.NutritionState(
          date: "2025-12-02",
          consumed: ncp.NutritionData(
            protein: 120.0,
            fat: 55.0,
            carbs: 160.0,
            calories: 1535.0,
          ),
          synced_at: "2025-12-02T10:00:00Z",
        )

      case
        storage.save_nutrition_state(conn, state1),
        storage.save_nutrition_state(conn, state2)
      {
        Ok(_), Ok(_) -> {
          case storage.get_nutrition_history(conn, 10) {
            Ok(history) -> {
              list.length(history)
              |> should.be_true(fn(len) { len >= 2 })
            }
            Error(_) -> should.fail()
          }
        }
        _, _ -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_nutrition_history_respects_limit_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.get_nutrition_history(conn, 5) {
        Ok(history) -> {
          list.length(history)
          |> should.be_true(fn(len) { len <= 5 })
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

// ============================================================================
// Nutrition Goals Storage Tests
// ============================================================================

pub fn storage_save_goals_valid_data_succeeds_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let goals =
        ncp.NutritionGoals(
          daily_protein: 150.0,
          daily_fat: 60.0,
          daily_carbs: 200.0,
          daily_calories: 1940.0,
        )

      case storage.save_goals(conn, goals) {
        Ok(_) -> {
          case storage.get_goals(conn) {
            Ok(retrieved) -> {
              retrieved.daily_protein
              |> should.equal(150.0)
              retrieved.daily_calories
              |> should.equal(1940.0)
            }
            Error(_) -> should.fail()
          }
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_save_goals_upserts_on_conflict_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let goals1 =
        ncp.NutritionGoals(
          daily_protein: 150.0,
          daily_fat: 60.0,
          daily_carbs: 200.0,
          daily_calories: 1940.0,
        )

      let goals2 =
        ncp.NutritionGoals(
          daily_protein: 180.0,
          daily_fat: 70.0,
          daily_carbs: 220.0,
          daily_calories: 2150.0,
        )

      case
        storage.save_goals(conn, goals1),
        storage.save_goals(conn, goals2)
      {
        Ok(_), Ok(_) -> {
          case storage.get_goals(conn) {
            Ok(retrieved) -> {
              // Should have updated values, not original
              retrieved.daily_protein
              |> should.equal(180.0)
            }
            Error(_) -> should.fail()
          }
        }
        _, _ -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_goals_not_found_when_empty_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.get_goals(conn) {
        Error(storage.NotFound) -> Nil
        Error(_) -> should.fail()
        Ok(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

// ============================================================================
// User Profile Storage Tests
// ============================================================================

pub fn storage_save_user_profile_valid_data_succeeds_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let profile =
        UserProfile(
          id: "1",
          bodyweight: 180.0,
          activity_level: Moderate,
          goal: Maintain,
          meals_per_day: 3,
        )

      case storage.save_user_profile(conn, profile) {
        Ok(_) -> {
          case storage.get_user_profile(conn) {
            Ok(retrieved) -> {
              retrieved.bodyweight
              |> should.equal(180.0)
              retrieved.activity_level
              |> should.equal(Moderate)
              retrieved.goal
              |> should.equal(Maintain)
            }
            Error(_) -> should.fail()
          }
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_save_user_profile_all_activity_levels_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let profiles = [
        UserProfile("1", 180.0, Sedentary, Maintain, 3),
        UserProfile("1", 180.0, Moderate, Maintain, 3),
        UserProfile("1", 180.0, Active, Maintain, 3),
      ]

      list.each(profiles, fn(profile) {
        case storage.save_user_profile(conn, profile) {
          Ok(_) -> {
            case storage.get_user_profile(conn) {
              Ok(retrieved) -> {
                retrieved.activity_level
                |> should.equal(profile.activity_level)
              }
              Error(_) -> should.fail()
            }
          }
          Error(_) -> should.fail()
        }
      })
    }
    Error(_) -> Nil
  }
}

pub fn storage_save_user_profile_all_goals_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let profiles = [
        UserProfile("1", 180.0, Moderate, Gain, 3),
        UserProfile("1", 180.0, Moderate, Maintain, 3),
        UserProfile("1", 180.0, Moderate, Lose, 3),
      ]

      list.each(profiles, fn(profile) {
        case storage.save_user_profile(conn, profile) {
          Ok(_) -> {
            case storage.get_user_profile(conn) {
              Ok(retrieved) -> {
                retrieved.goal
                |> should.equal(profile.goal)
              }
              Error(_) -> should.fail()
            }
          }
          Error(_) -> should.fail()
        }
      })
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_user_profile_or_default_returns_default_when_not_found_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let profile = storage.get_user_profile_or_default(conn)

      profile.bodyweight
      |> should.equal(180.0)

      profile.activity_level
      |> should.equal(Moderate)

      profile.goal
      |> should.equal(Maintain)

      profile.meals_per_day
      |> should.equal(3)
    }
    Error(_) -> Nil
  }
}

// ============================================================================
// Recipe Storage Tests
// ============================================================================

pub fn storage_save_recipe_valid_data_succeeds_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let recipe =
        Recipe(
          id: "test-recipe-1",
          name: "Test Chicken",
          ingredients: [
            Ingredient("Chicken breast", "200g"),
            Ingredient("Rice", "100g"),
          ],
          instructions: ["Cook chicken", "Prepare rice", "Serve"],
          macros: Macros(protein: 40.0, fat: 10.0, carbs: 30.0),
          servings: 1,
          category: "poultry",
          fodmap_level: Low,
          vertical_compliant: True,
        )

      case storage.save_recipe(conn, recipe) {
        Ok(_) -> {
          case storage.get_recipe_by_id(conn, "test-recipe-1") {
            Ok(retrieved) -> {
              retrieved.name
              |> should.equal("Test Chicken")
              retrieved.macros.protein
              |> should.equal(40.0)
              retrieved.vertical_compliant
              |> should.be_true()
            }
            Error(_) -> should.fail()
          }
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_save_recipe_upserts_on_conflict_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let recipe1 =
        Recipe(
          id: "test-recipe-2",
          name: "Original Name",
          ingredients: [Ingredient("Chicken", "100g")],
          instructions: ["Cook"],
          macros: Macros(protein: 20.0, fat: 5.0, carbs: 10.0),
          servings: 1,
          category: "poultry",
          fodmap_level: Low,
          vertical_compliant: True,
        )

      let recipe2 =
        Recipe(
          id: "test-recipe-2",
          name: "Updated Name",
          ingredients: [Ingredient("Beef", "100g")],
          instructions: ["Grill"],
          macros: Macros(protein: 25.0, fat: 8.0, carbs: 5.0),
          servings: 1,
          category: "red-meat",
          fodmap_level: Medium,
          vertical_compliant: False,
        )

      case storage.save_recipe(conn, recipe1), storage.save_recipe(conn, recipe2)
      {
        Ok(_), Ok(_) -> {
          case storage.get_recipe_by_id(conn, "test-recipe-2") {
            Ok(retrieved) -> {
              retrieved.name
              |> should.equal("Updated Name")
              retrieved.category
              |> should.equal("red-meat")
            }
            Error(_) -> should.fail()
          }
        }
        _, _ -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_all_recipes_returns_sorted_list_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let recipe1 =
        Recipe(
          id: "z-recipe",
          name: "Zebra Steak",
          ingredients: [],
          instructions: [],
          macros: Macros(protein: 20.0, fat: 5.0, carbs: 10.0),
          servings: 1,
          category: "exotic",
          fodmap_level: Low,
          vertical_compliant: False,
        )

      let recipe2 =
        Recipe(
          id: "a-recipe",
          name: "Apple Pie",
          ingredients: [],
          instructions: [],
          macros: Macros(protein: 5.0, fat: 15.0, carbs: 40.0),
          servings: 1,
          category: "dessert",
          fodmap_level: High,
          vertical_compliant: False,
        )

      case storage.save_recipe(conn, recipe1), storage.save_recipe(conn, recipe2)
      {
        Ok(_), Ok(_) -> {
          case storage.get_all_recipes(conn) {
            Ok(recipes) -> {
              list.length(recipes)
              |> should.be_true(fn(len) { len >= 2 })

              // Check first recipe is alphabetically first
              case recipes {
                [first, ..] -> {
                  first.name
                  |> should.equal("Apple Pie")
                }
                [] -> should.fail()
              }
            }
            Error(_) -> should.fail()
          }
        }
        _, _ -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_recipe_by_id_not_found_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.get_recipe_by_id(conn, "nonexistent-recipe") {
        Error(storage.NotFound) -> Nil
        Error(_) -> should.fail()
        Ok(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_delete_recipe_removes_recipe_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let recipe =
        Recipe(
          id: "delete-test",
          name: "To Delete",
          ingredients: [],
          instructions: [],
          macros: Macros(protein: 10.0, fat: 5.0, carbs: 15.0),
          servings: 1,
          category: "test",
          fodmap_level: Low,
          vertical_compliant: False,
        )

      case storage.save_recipe(conn, recipe) {
        Ok(_) -> {
          case storage.delete_recipe(conn, "delete-test") {
            Ok(_) -> {
              case storage.get_recipe_by_id(conn, "delete-test") {
                Error(storage.NotFound) -> Nil
                Error(_) -> should.fail()
                Ok(_) -> should.fail()
              }
            }
            Error(_) -> should.fail()
          }
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_recipes_by_category_filters_correctly_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let poultry_recipe =
        Recipe(
          id: "chicken-1",
          name: "Chicken Dish",
          ingredients: [],
          instructions: [],
          macros: Macros(protein: 30.0, fat: 10.0, carbs: 20.0),
          servings: 1,
          category: "poultry",
          fodmap_level: Low,
          vertical_compliant: True,
        )

      let beef_recipe =
        Recipe(
          id: "beef-1",
          name: "Beef Dish",
          ingredients: [],
          instructions: [],
          macros: Macros(protein: 35.0, fat: 15.0, carbs: 10.0),
          servings: 1,
          category: "red-meat",
          fodmap_level: Low,
          vertical_compliant: True,
        )

      case
        storage.save_recipe(conn, poultry_recipe),
        storage.save_recipe(conn, beef_recipe)
      {
        Ok(_), Ok(_) -> {
          case storage.get_recipes_by_category(conn, "poultry") {
            Ok(recipes) -> {
              list.all(recipes, fn(r) { r.category == "poultry" })
              |> should.be_true()
            }
            Error(_) -> should.fail()
          }
        }
        _, _ -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_recipes_by_category_empty_result_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.get_recipes_by_category(conn, "nonexistent-category") {
        Ok(recipes) -> {
          list.length(recipes)
          |> should.equal(0)
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

// ============================================================================
// USDA Food Search Tests
// ============================================================================

pub fn storage_search_foods_returns_results_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.search_foods(conn, "chicken", 10) {
        Ok(foods) -> {
          list.length(foods)
          |> should.be_true(fn(len) { len >= 0 })
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_search_foods_respects_limit_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.search_foods(conn, "chicken", 5) {
        Ok(foods) -> {
          list.length(foods)
          |> should.be_true(fn(len) { len <= 5 })
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_foods_count_returns_non_negative_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.get_foods_count(conn) {
        Ok(count) -> {
          count
          |> should.be_true(fn(c) { c >= 0 })
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

// ============================================================================
// Food Log Tests
// ============================================================================

pub fn storage_save_food_log_valid_data_succeeds_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let log =
        storage.FoodLog(
          id: "log-1",
          date: "2025-12-03",
          recipe_id: "test-recipe",
          recipe_name: "Test Meal",
          servings: 1.0,
          protein: 30.0,
          fat: 10.0,
          carbs: 40.0,
          meal_type: "breakfast",
          logged_at: "2025-12-03T08:00:00Z",
          fiber: None,
          sugar: None,
          sodium: None,
          cholesterol: None,
          vitamin_a: None,
          vitamin_c: None,
          vitamin_d: None,
          vitamin_e: None,
          vitamin_k: None,
          vitamin_b6: None,
          vitamin_b12: None,
          folate: None,
          thiamin: None,
          riboflavin: None,
          niacin: None,
          calcium: None,
          iron: None,
          magnesium: None,
          phosphorus: None,
          potassium: None,
          zinc: None,
        )

      case storage.save_food_log(conn, log) {
        Ok(_) -> {
          case storage.get_food_logs_by_date(conn, "2025-12-03") {
            Ok(logs) -> {
              list.length(logs)
              |> should.be_true(fn(len) { len >= 1 })
            }
            Error(_) -> should.fail()
          }
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_food_logs_by_date_empty_result_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.get_food_logs_by_date(conn, "1999-01-01") {
        Ok(logs) -> {
          list.length(logs)
          |> should.equal(0)
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_delete_food_log_removes_entry_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let log =
        storage.FoodLog(
          id: "log-delete",
          date: "2025-12-03",
          recipe_id: "test",
          recipe_name: "Test",
          servings: 1.0,
          protein: 20.0,
          fat: 10.0,
          carbs: 30.0,
          meal_type: "lunch",
          logged_at: "2025-12-03T12:00:00Z",
          fiber: None,
          sugar: None,
          sodium: None,
          cholesterol: None,
          vitamin_a: None,
          vitamin_c: None,
          vitamin_d: None,
          vitamin_e: None,
          vitamin_k: None,
          vitamin_b6: None,
          vitamin_b12: None,
          folate: None,
          thiamin: None,
          riboflavin: None,
          niacin: None,
          calcium: None,
          iron: None,
          magnesium: None,
          phosphorus: None,
          potassium: None,
          zinc: None,
        )

      case storage.save_food_log(conn, log) {
        Ok(_) -> {
          case storage.delete_food_log(conn, "log-delete") {
            Ok(_) -> Nil
            Error(_) -> should.fail()
          }
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_recent_meals_respects_limit_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.get_recent_meals(conn, 5) {
        Ok(meals) -> {
          list.length(meals)
          |> should.be_true(fn(len) { len <= 5 })
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

// ============================================================================
// Daily Log Tests
// ============================================================================

pub fn storage_get_daily_log_aggregates_entries_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let entry1 =
        types.FoodLogEntry(
          id: "entry-1",
          recipe_id: "recipe-1",
          recipe_name: "Breakfast",
          servings: 1.0,
          macros: Macros(protein: 20.0, fat: 10.0, carbs: 30.0),
          micronutrients: None,
          meal_type: Breakfast,
          logged_at: "2025-12-03T08:00:00Z",
          source_type: "recipe",
          source_id: "recipe-1",
        )

      let entry2 =
        types.FoodLogEntry(
          id: "entry-2",
          recipe_id: "recipe-2",
          recipe_name: "Lunch",
          servings: 1.0,
          macros: Macros(protein: 30.0, fat: 15.0, carbs: 40.0),
          micronutrients: None,
          meal_type: Lunch,
          logged_at: "2025-12-03T12:00:00Z",
          source_type: "recipe",
          source_id: "recipe-2",
        )

      case
        storage.save_food_log_entry(conn, "2025-12-03", entry1),
        storage.save_food_log_entry(conn, "2025-12-03", entry2)
      {
        Ok(_), Ok(_) -> {
          case storage.get_daily_log(conn, "2025-12-03") {
            Ok(daily_log) -> {
              daily_log.date
              |> should.equal("2025-12-03")

              list.length(daily_log.entries)
              |> should.be_true(fn(len) { len >= 2 })

              daily_log.total_macros.protein
              |> should.be_true(fn(p) { p >= 50.0 })
            }
            Error(_) -> should.fail()
          }
        }
        _, _ -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

// ============================================================================
// Edge Case Tests
// ============================================================================

pub fn storage_save_recipe_empty_ingredients_succeeds_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let recipe =
        Recipe(
          id: "empty-ingredients",
          name: "Empty Test",
          ingredients: [],
          instructions: ["Just serve"],
          macros: Macros(protein: 0.0, fat: 0.0, carbs: 0.0),
          servings: 1,
          category: "test",
          fodmap_level: Low,
          vertical_compliant: False,
        )

      case storage.save_recipe(conn, recipe) {
        Ok(_) -> Nil
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_save_recipe_empty_instructions_succeeds_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let recipe =
        Recipe(
          id: "empty-instructions",
          name: "No Instructions",
          ingredients: [Ingredient("Something", "100g")],
          instructions: [],
          macros: Macros(protein: 10.0, fat: 5.0, carbs: 15.0),
          servings: 1,
          category: "test",
          fodmap_level: Medium,
          vertical_compliant: False,
        )

      case storage.save_recipe(conn, recipe) {
        Ok(_) -> Nil
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_save_recipe_zero_servings_succeeds_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let recipe =
        Recipe(
          id: "zero-servings",
          name: "Zero Servings",
          ingredients: [Ingredient("Test", "100g")],
          instructions: ["Test"],
          macros: Macros(protein: 10.0, fat: 5.0, carbs: 15.0),
          servings: 0,
          category: "test",
          fodmap_level: Low,
          vertical_compliant: False,
        )

      case storage.save_recipe(conn, recipe) {
        Ok(_) -> Nil
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_nutrition_state_zero_values_succeeds_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let state =
        ncp.NutritionState(
          date: "2025-12-03",
          consumed: ncp.NutritionData(
            protein: 0.0,
            fat: 0.0,
            carbs: 0.0,
            calories: 0.0,
          ),
          synced_at: "2025-12-03T10:00:00Z",
        )

      case storage.save_nutrition_state(conn, state) {
        Ok(_) -> Nil
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_user_profile_zero_bodyweight_succeeds_test() {
  case test_db.setup() {
    Ok(conn) -> {
      let profile =
        UserProfile(
          id: "1",
          bodyweight: 0.0,
          activity_level: Sedentary,
          goal: Maintain,
          meals_per_day: 1,
        )

      case storage.save_user_profile(conn, profile) {
        Ok(_) -> Nil
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

// ============================================================================
// Error Path Tests
// ============================================================================

pub fn storage_get_nutrition_state_empty_date_returns_error_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.get_nutrition_state(conn, "") {
        Error(_) -> Nil
        Ok(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_nutrition_history_zero_limit_returns_empty_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.get_nutrition_history(conn, 0) {
        Ok(history) -> {
          list.length(history)
          |> should.equal(0)
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}

pub fn storage_get_nutrition_history_negative_limit_returns_empty_test() {
  case test_db.setup() {
    Ok(conn) -> {
      case storage.get_nutrition_history(conn, -1) {
        Ok(history) -> {
          list.length(history)
          |> should.equal(0)
        }
        Error(_) -> should.fail()
      }
    }
    Error(_) -> Nil
  }
}
