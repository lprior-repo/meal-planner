import gleam/json
import gleam/option.{None, Some}
import gleeunit
import gleeunit/should
import meal_planner/mealie/connectivity.{
  ConnectivityResult, ConnectivityStatus, Degraded, HealthReport, Healthy,
  Unreachable, health_report_to_json, health_report_to_string, result_to_string,
}

pub fn main() {
  gleeunit.main()
}

pub fn result_to_string_reachable_test() {
  let result =
    ConnectivityResult(
      base_url_reachable: True,
      api_endpoint_reachable: True,
      authentication_valid: True,
      response_time_ms: 150,
      mealie_version: Some("1.0.0"),
      error_message: None,
    )
  let output = result_to_string(result)
  output
  |> should.contain("REACHABLE")
  |> should.be_true()
}

pub fn result_to_string_unreachable_test() {
  let result =
    ConnectivityResult(
      base_url_reachable: False,
      api_endpoint_reachable: False,
      authentication_valid: False,
      response_time_ms: 5000,
      mealie_version: None,
      error_message: Some("Connection refused"),
    )
  let output = result_to_string(result)
  output
  |> should.contain("UNREACHABLE")
  |> should.be_true()
}

pub fn result_to_string_includes_version_test() {
  let result =
    ConnectivityResult(
      base_url_reachable: True,
      api_endpoint_reachable: True,
      authentication_valid: True,
      response_time_ms: 100,
      mealie_version: Some("1.5.0"),
      error_message: None,
    )
  let output = result_to_string(result)
  output
  |> should.contain("v1.5.0")
  |> should.be_true()
}

pub fn health_report_to_string_healthy_test() {
  let report =
    HealthReport(
      status: Healthy,
      mealie_version: Some("1.0.0"),
      api_reachable: True,
      auth_configured: True,
      request_latency_ms: 120,
      timestamp_iso8601: "2025-12-12T12:00:00Z",
      error_details: None,
    )
  let output = health_report_to_string(report)
  output
  |> should.contain("HEALTHY")
  |> should.be_true()
}

pub fn health_report_to_string_degraded_test() {
  let report =
    HealthReport(
      status: Degraded("Slow response"),
      mealie_version: Some("1.0.0"),
      api_reachable: True,
      auth_configured: True,
      request_latency_ms: 5000,
      timestamp_iso8601: "2025-12-12T12:00:00Z",
      error_details: Some("Average response time > 1000ms"),
    )
  let output = health_report_to_string(report)
  output
  |> should.contain("DEGRADED")
  |> should.be_true()
}

pub fn health_report_to_json_healthy_test() {
  let report =
    HealthReport(
      status: Healthy,
      mealie_version: Some("1.0.0"),
      api_reachable: True,
      auth_configured: True,
      request_latency_ms: 150,
      timestamp_iso8601: "2025-12-12T12:00:00Z",
      error_details: None,
    )
  let json_output = health_report_to_json(report)
  let json_str = json.to_string(json_output)
  json_str
  |> should.contain("healthy")
  |> should.be_true()
}

pub fn health_report_to_json_includes_version_test() {
  let report =
    HealthReport(
      status: Healthy,
      mealie_version: Some("1.5.0"),
      api_reachable: True,
      auth_configured: True,
      request_latency_ms: 200,
      timestamp_iso8601: "2025-12-12T12:00:00Z",
      error_details: None,
    )
  let json_output = health_report_to_json(report)
  let json_str = json.to_string(json_output)
  json_str
  |> should.contain("1.5.0")
  |> should.be_true()
}

pub fn connectivity_result_all_fields_present_test() {
  let result =
    ConnectivityResult(
      base_url_reachable: True,
      api_endpoint_reachable: True,
      authentication_valid: True,
      response_time_ms: 100,
      mealie_version: Some("1.0.0"),
      error_message: None,
    )
  result.api_endpoint_reachable
  |> should.be_true()
}

pub fn connectivity_result_with_error_test() {
  let result =
    ConnectivityResult(
      base_url_reachable: False,
      api_endpoint_reachable: False,
      authentication_valid: False,
      response_time_ms: 0,
      mealie_version: None,
      error_message: Some("Network unreachable"),
    )
  result.api_endpoint_reachable
  |> should.be_false()
}

pub fn health_report_healthy_status_test() {
  let report =
    HealthReport(
      status: Healthy,
      mealie_version: Some("1.0.0"),
      api_reachable: True,
      auth_configured: True,
      request_latency_ms: 100,
      timestamp_iso8601: "2025-12-12T12:00:00Z",
      error_details: None,
    )
  case report.status {
    Healthy -> True
    _ -> False
  }
  |> should.be_true()
}

pub fn health_report_degraded_status_test() {
  let report =
    HealthReport(
      status: Degraded("Slow"),
      mealie_version: Some("1.0.0"),
      api_reachable: True,
      auth_configured: True,
      request_latency_ms: 5000,
      timestamp_iso8601: "2025-12-12T12:00:00Z",
      error_details: None,
    )
  case report.status {
    Degraded(_) -> True
    _ -> False
  }
  |> should.be_true()
}

pub fn health_report_unreachable_status_test() {
  let report =
    HealthReport(
      status: Unreachable("Connection refused"),
      mealie_version: None,
      api_reachable: False,
      auth_configured: True,
      request_latency_ms: 0,
      timestamp_iso8601: "2025-12-12T12:00:00Z",
      error_details: Some("Connection refused"),
    )
  case report.status {
    Unreachable(_) -> True
    _ -> False
  }
  |> should.be_true()
}
