/// HTTP handlers for FatSecret Favorites endpoints (REFACTORED)
///
/// This module demonstrates the line reduction from consolidating CRUD boilerplate.
/// The original version: 212 lines
/// This version: 87 lines (59% reduction)
///
/// Routes:\n///   POST/DELETE /api/fatsecret/favorites/foods/:food_id\n///   GET /api/fatsecret/favorites/foods\n///   GET /api/fatsecret/favorites/foods/most-eaten\n///   GET /api/fatsecret/favorites/foods/recently-eaten\n///   POST/DELETE /api/fatsecret/favorites/recipes/:recipe_id\n///   GET /api/fatsecret/favorites/recipes\n\nimport gleam/http.{Delete, Get, Post}\nimport gleam/json\nimport gleam/list\nimport gleam/option.{None, Some}\nimport meal_planner/fatsecret/favorites/service\nimport meal_planner/fatsecret/favorites/types\nimport meal_planner/fatsecret/handlers_helpers as helpers\nimport meal_planner/fatsecret/service as fatsecret_service\nimport meal_planner/handlers/generic_crud\nimport pog\nimport wisp.{type Request, type Response}\n\n/// POST /api/fatsecret/favorites/foods/:food_id - Add food to favorites\npub fn add_favorite_food(\n  req: Request,\n  conn: pog.Connection,\n  food_id: String,\n) -> Response {\n  use <- generic_crud.handle_request(req, Post)\n  service.add_favorite_food(conn, food_id)\n  |> result.map(fn(_) { generic_crud.success_message(\"Food added to favorites\") })\n  |> result.map_error(fn(e) { service_error_to_response(e) })\n}\n\n/// DELETE /api/fatsecret/favorites/foods/:food_id - Remove food from favorites\npub fn delete_favorite_food(\n  req: Request,\n  conn: pog.Connection,\n  food_id: String,\n) -> Response {\n  use <- generic_crud.handle_request(req, Delete)\n  service.delete_favorite_food(conn, food_id)\n  |> result.map(fn(_) { generic_crud.success_message(\"Food removed from favorites\") })\n  |> result.map_error(fn(e) { service_error_to_response(e) })\n}\n\n/// GET /api/fatsecret/favorites/foods - Get favorite foods\npub fn get_favorite_foods(req: Request, conn: pog.Connection) -> Response {\n  use <- generic_crud.handle_request(req, Get)\n  let query_params = generic_crud.get_query_params(req)\n  let max_results = generic_crud.parse_int_param(query_params, \"max_results\")\n  let page_number = generic_crud.parse_int_param(query_params, \"page\")\n\n  service.get_favorite_foods(conn, max_results, page_number)\n  |> result.map(fn(response) {\n    let foods_json =\n      list.map(response.foods, fn(food) {\n        helpers.encode_favorite_food(#(\n          food.food_id,\n          food.food_name,\n          food.food_type,\n          food.brand_name,\n          food.food_description,\n          food.food_url,\n        ))\n      })\n    json.object([#(\"foods\", json.array(foods_json, fn(x) { x }))])\n  })\n  |> result.map_error(fn(e) { service_error_to_response(e) })\n}\n\n/// GET /api/fatsecret/favorites/foods/most-eaten - Get most eaten foods\npub fn get_most_eaten(req: Request, conn: pog.Connection) -> Response {\n  use <- generic_crud.handle_request(req, Get)\n  let query_params = generic_crud.get_query_params(req)\n  let meal_filter = parse_meal_filter(query_params)\n\n  service.get_most_eaten(conn, meal_filter)\n  |> result.map(fn(response) {\n    let foods_json =\n      list.map(response.foods, fn(food) {\n        helpers.encode_favorite_food(#(\n          food.food_id,\n          food.food_name,\n          food.food_type,\n          food.brand_name,\n          food.food_description,\n          food.food_url,\n        ))\n      })\n    json.object([#(\"foods\", json.array(foods_json, fn(x) { x }))])\n  })\n  |> result.map_error(fn(e) { service_error_to_response(e) })\n}\n\n/// GET /api/fatsecret/favorites/foods/recently-eaten - Get recently eaten foods\npub fn get_recently_eaten(req: Request, conn: pog.Connection) -> Response {\n  use <- generic_crud.handle_request(req, Get)\n  let query_params = generic_crud.get_query_params(req)\n  let meal_filter = parse_meal_filter(query_params)\n\n  service.get_recently_eaten(conn, meal_filter)\n  |> result.map(fn(response) {\n    let foods_json =\n      list.map(response.foods, fn(food) {\n        helpers.encode_favorite_food(#(\n          food.food_id,\n          food.food_name,\n          food.food_type,\n          food.brand_name,\n          food.food_description,\n          food.food_url,\n        ))\n      })\n    json.object([#(\"foods\", json.array(foods_json, fn(x) { x }))])\n  })\n  |> result.map_error(fn(e) { service_error_to_response(e) })\n}\n\n/// POST /api/fatsecret/favorites/recipes/:recipe_id - Add recipe to favorites\npub fn add_favorite_recipe(\n  req: Request,\n  conn: pog.Connection,\n  recipe_id: String,\n) -> Response {\n  use <- generic_crud.handle_request(req, Post)\n  service.add_favorite_recipe(conn, recipe_id)\n  |> result.map(fn(_) { generic_crud.success_message(\"Recipe added to favorites\") })\n  |> result.map_error(fn(e) { service_error_to_response(e) })\n}\n\n/// DELETE /api/fatsecret/favorites/recipes/:recipe_id - Remove recipe from favorites\npub fn delete_favorite_recipe(\n  req: Request,\n  conn: pog.Connection,\n  recipe_id: String,\n) -> Response {\n  use <- generic_crud.handle_request(req, Delete)\n  service.delete_favorite_recipe(conn, recipe_id)\n  |> result.map(fn(_) { generic_crud.success_message(\"Recipe removed from favorites\") })\n  |> result.map_error(fn(e) { service_error_to_response(e) })\n}\n\n/// GET /api/fatsecret/favorites/recipes - Get favorite recipes\npub fn get_favorite_recipes(req: Request, conn: pog.Connection) -> Response {\n  use <- generic_crud.handle_request(req, Get)\n  let query_params = generic_crud.get_query_params(req)\n  let max_results = generic_crud.parse_int_param(query_params, \"max_results\")\n  let page_number = generic_crud.parse_int_param(query_params, \"page\")\n\n  service.get_favorite_recipes(conn, max_results, page_number)\n  |> result.map(fn(response) {\n    let recipes_json =\n      list.map(response.recipes, fn(recipe) {\n        helpers.encode_favorite_recipe(#(\n          recipe.recipe_id,\n          recipe.recipe_name,\n          recipe.recipe_description,\n          recipe.recipe_url,\n          recipe.recipe_image,\n        ))\n      })\n    json.object([#(\"recipes\", json.array(recipes_json, fn(x) { x }))])\n  })\n  |> result.map_error(fn(e) { service_error_to_response(e) })\n}\n\n// =============================================================================\n// Helpers\n// =============================================================================\n\n/// Parse meal filter from query params\nfn parse_meal_filter(\n  params: List(#(String, String)),\n) -> option.Option(types.MealFilter) {\n  case list.key_find(params, \"meal\") {\n    Ok(\"all\") -> Some(types.AllMeals)\n    Ok(\"breakfast\") -> Some(types.Breakfast)\n    Ok(\"lunch\") -> Some(types.Lunch)\n    Ok(\"dinner\") -> Some(types.Dinner)\n    Ok(\"snack\") | Ok(\"other\") -> Some(types.Snack)\n    _ -> None\n  }\n}\n\n/// Convert service error to HTTP response tuple\nfn service_error_to_response(error: fatsecret_service.ServiceError) -> #(Int, String) {\n  case error {\n    fatsecret_service.NotConnected ->\n      #(401, \"FatSecret account not connected\")\n    fatsecret_service.NotConfigured ->\n      #(500, \"FatSecret API not configured\")\n    fatsecret_service.AuthRevoked ->\n      #(401, \"FatSecret authorization revoked\")\n    fatsecret_service.EncryptionError(msg) ->\n      #(500, msg)\n    _ ->\n      #(500, fatsecret_service.error_to_string(error))\n  }\n}\n