# Nginx configuration for Gleam Meal Planner with compression
# Phase 1 Performance Optimization: Response Compression
# Reference: PERFORMANCE_ANALYSIS.md Section 3.3
#
# SETUP:
# 1. Install nginx: sudo apt install nginx
# 2. Copy this file to: /etc/nginx/sites-available/meal-planner
# 3. Enable site: sudo ln -s /etc/nginx/sites-available/meal-planner /etc/nginx/sites-enabled/
# 4. Test config: sudo nginx -t
# 5. Reload nginx: sudo systemctl reload nginx
#
# IMPACT: 70-85% bandwidth reduction for JSON/HTML responses

server {
    listen 80;
    server_name localhost;

    # Compression settings
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;  # Balance between compression ratio and CPU usage
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Brotli compression (better than gzip, requires nginx-mod-brotli)
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types
    #     text/plain
    #     text/css
    #     text/xml
    #     text/javascript
    #     application/json
    #     application/javascript;

    # Static file caching
    location /static/ {
        proxy_pass http://localhost:8080/static/;
        proxy_cache_valid 200 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    # API responses (short cache)
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_valid 200 5m;
        add_header Cache-Control "public, max-age=300";
    }

    # SSR pages
    location / {
        proxy_pass http://localhost:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Alternative: Caddy configuration (automatic HTTPS + compression)
# Save as Caddyfile in project root:
#
# localhost:80 {
#     encode gzip zstd  # Automatic compression
#     reverse_proxy localhost:8080
#
#     handle /static/* {
#         header Cache-Control "public, max-age=3600"
#         reverse_proxy localhost:8080
#     }
#
#     handle /api/* {
#         header Cache-Control "public, max-age=300"
#         reverse_proxy localhost:8080
#     }
# }
