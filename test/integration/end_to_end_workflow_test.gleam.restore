//// Integration Workflow Tests (GREEN Phase - Minimal Passing Implementation)
////
//// Simplified tests with stub implementations that verify core workflow exists

import gleam/list
import gleam/option.{Some}
import gleam/string
import gleeunit/should
import meal_planner/email/confirmation
import meal_planner/email/parser
import meal_planner/generator/weekly
import meal_planner/id
import meal_planner/types.{
  type Macros, AdjustMeal, Dinner, Friday, Macros,
}

// ============================================================================
// Test Data
// ============================================================================

fn test_target_macros() -> Macros {
  Macros(protein: 180.0, fat: 60.0, carbs: 200.0)
}

fn sample_recipe(recipe_id: String, name: String) -> types.Recipe {
  types.Recipe(
    id: id.recipe_id(recipe_id),
    name: name,
    ingredients: [],
    instructions: [],
    macros: Macros(protein: 40.0, fat: 15.0, carbs: 50.0),
    servings: 1,
    category: "Dinner",
    fodmap_level: types.Low,
    vertical_compliant: True,
  )
}

// ============================================================================
// Test 1: Weekly Generation Works
// ============================================================================

pub fn test_weekly_generation_produces_7_days() {
  let recipes = [
    sample_recipe("r1", "Recipe 1"),
    sample_recipe("r2", "Recipe 2"),
    sample_recipe("r3", "Recipe 3"),
    sample_recipe("r4", "Recipe 4"),
    sample_recipe("r5", "Recipe 5"),
    sample_recipe("r6", "Recipe 6"),
    sample_recipe("r7", "Recipe 7"),
  ]

  let result =
    weekly.generate_weekly_plan(
      "2025-12-22",
      recipes,
      test_target_macros(),
    )

  result
  |> should.be_ok

  case result {
    Ok(plan) -> {
      plan.days
      |> list.length
      |> should.equal(7)
    }
    Error(_) -> should.fail()
  }
}

// ============================================================================
// Test 2: Email Parser Works
// ============================================================================

pub fn test_email_parser_extracts_commands() {
  let email = types.EmailRequest(
    from_email: "test@example.com",
    subject: "Meal adjustment",
    body: "@Claude adjust Friday dinner to recipe-pasta-123",
    is_reply: False,
  )

  let result = parser.parse_email_command(email)

  result
  |> should.be_ok

  case result {
    Ok(AdjustMeal(day, meal_type, _recipe_id)) -> {
      day
      |> should.equal(Friday)

      meal_type
      |> should.equal(Dinner)
    }
    _ -> should.fail()
  }
}

// ============================================================================
// Test 3: Email Confirmation Generation Works
// ============================================================================

pub fn test_email_confirmation_generation() {
  let command = AdjustMeal(Friday, Dinner, id.recipe_id("recipe-123"))
  
  let exec_result = types.CommandExecutionResult(
    success: True,
    message: "Updated Friday dinner",
    command: Some(command),
  )

  let confirmation = confirmation.generate_confirmation(
    exec_result,
    "test@example.com",
  )

  confirmation.subject
  |> string.contains("Friday")
  |> should.be_true

  confirmation.body
  |> string.contains("dinner")
  |> should.be_true
}

// ============================================================================
// Test 4: Stub Integration - Email Sending (GREEN Phase Stub)
// ============================================================================

pub fn test_email_sending_stub() {
  // GREEN PHASE: Stub implementation that returns success
  // Actual email sending would require external service
  let send_result: Result(Nil, String) = Ok(Nil)

  send_result
  |> should.be_ok
}
