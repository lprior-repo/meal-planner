{
  "description": "Agent Mail MCP - Error Handling and Retry Scenarios",
  "scenario": "Error conditions and recovery mechanisms",
  "error_cases": [
    {
      "name": "agent_not_registered",
      "action": "send_message",
      "from_agent": "UnknownAgent",
      "error_code": "AGENT_NOT_REGISTERED",
      "error_message": "Agent 'UnknownAgent' not registered in project",
      "recovery": "Call register_agent first"
    },
    {
      "name": "file_reservation_conflict",
      "action": "file_reservation_paths",
      "agent_name": "BlueTower",
      "paths": ["src/meal_planner/auth.gleam"],
      "error_code": "FILE_RESERVATION_CONFLICT",
      "error_message": "File already reserved by GreenCastle",
      "existing_reservation": {
        "agent_name": "GreenCastle",
        "paths": ["src/meal_planner/auth.gleam"],
        "expires_at": "2025-12-19T12:05:00Z"
      },
      "recovery": "Wait for expiry or request release"
    },
    {
      "name": "message_not_found",
      "action": "acknowledge_message",
      "message_id": "msg-999",
      "error_code": "MESSAGE_NOT_FOUND",
      "error_message": "Message 'msg-999' does not exist",
      "recovery": "Verify message ID"
    },
    {
      "name": "task_not_found",
      "action": "update_task_status",
      "bead_id": "bd-999",
      "error_code": "TASK_NOT_FOUND",
      "error_message": "Task 'bd-999' not found in coordination",
      "recovery": "Create task with assign_task first"
    },
    {
      "name": "invalid_status_transition",
      "action": "update_task_status",
      "bead_id": "bd-126",
      "from_status": "Completed",
      "to_status": "InProgress",
      "error_code": "INVALID_STATUS_TRANSITION",
      "error_message": "Cannot transition from Completed to InProgress",
      "recovery": "Use retry_task for failed tasks only"
    }
  ],
  "retry_scenarios": [
    {
      "description": "Task failure with automatic retry",
      "bead_id": "bd-130",
      "initial_status": "InProgress",
      "failure_reason": "External API timeout",
      "retry_policy": {
        "max_attempts": 3,
        "current_attempt": 1,
        "backoff_seconds": 60
      },
      "steps": [
        {
          "attempt": 1,
          "status": "Failed",
          "error": "API timeout",
          "action": "retry_task"
        },
        {
          "attempt": 2,
          "status": "InProgress",
          "action": "execute_task"
        },
        {
          "attempt": 2,
          "status": "Completed",
          "result": "success"
        }
      ],
      "expected_result": {
        "status": "Completed",
        "total_attempts": 2,
        "final_attempt_succeeded": true
      }
    },
    {
      "description": "Max retry attempts exhausted",
      "bead_id": "bd-131",
      "retry_policy": {
        "max_attempts": 3,
        "current_attempt": 3,
        "backoff_seconds": 60
      },
      "steps": [
        {"attempt": 1, "status": "Failed"},
        {"attempt": 2, "status": "Failed"},
        {"attempt": 3, "status": "Failed"}
      ],
      "expected_result": {
        "status": "Failed",
        "total_attempts": 3,
        "retry_exhausted": true,
        "requires_manual_intervention": true
      }
    }
  ],
  "timeout_scenarios": [
    {
      "description": "Message acknowledgment timeout",
      "message_id": "msg-010",
      "ack_required": true,
      "sent_at": "2025-12-19T14:00:00Z",
      "ack_deadline": "2025-12-19T14:10:00Z",
      "current_time": "2025-12-19T14:15:00Z",
      "expected_result": {
        "ack_status": "overdue",
        "escalation": "send reminder to recipient",
        "action": "notify sender of timeout"
      }
    },
    {
      "description": "File reservation TTL expiration",
      "reservation": {
        "agent_name": "GreenCastle",
        "paths": ["src/meal_planner/temp.gleam"],
        "ttl_seconds": 300,
        "reserved_at": "2025-12-19T14:00:00Z",
        "expires_at": "2025-12-19T14:05:00Z"
      },
      "current_time": "2025-12-19T14:06:00Z",
      "expected_result": {
        "reservation_status": "expired",
        "available_for_reservation": true,
        "cleanup_triggered": true
      }
    }
  ],
  "deadlock_scenarios": [
    {
      "description": "Circular file dependency deadlock",
      "agents": [
        {
          "name": "GreenCastle",
          "has_reserved": ["file_a.gleam"],
          "waiting_for": ["file_b.gleam"],
          "reason": "bd-140"
        },
        {
          "name": "BlueTower",
          "has_reserved": ["file_b.gleam"],
          "waiting_for": ["file_a.gleam"],
          "reason": "bd-141"
        }
      ],
      "detection": {
        "deadlock_detected": true,
        "involved_agents": ["GreenCastle", "BlueTower"],
        "involved_files": ["file_a.gleam", "file_b.gleam"],
        "cycle": ["GreenCastle -> file_b.gleam -> BlueTower -> file_a.gleam -> GreenCastle"]
      },
      "resolution_options": [
        {
          "strategy": "timeout",
          "action": "Force release after TTL expiration",
          "chosen_agent": "GreenCastle (lower priority task)"
        },
        {
          "strategy": "manual_intervention",
          "action": "Human decides which agent releases files",
          "notification": "Send alert to project maintainer"
        },
        {
          "strategy": "priority_based",
          "action": "Lower priority agent releases files",
          "chosen_agent": "GreenCastle (priority 2 vs BlueTower priority 1)"
        }
      ]
    }
  ],
  "expected_behavior": {
    "error_handling": {
      "returns_result_type": true,
      "error_contains_details": true,
      "error_suggests_recovery": true
    },
    "retry_behavior": {
      "respects_max_attempts": true,
      "applies_backoff": true,
      "tracks_attempt_count": true
    },
    "timeout_behavior": {
      "enforces_ttl": true,
      "auto_cleanup_expired": true,
      "sends_timeout_notifications": true
    },
    "deadlock_behavior": {
      "detects_cycles": true,
      "suggests_resolution": true,
      "prevents_indefinite_waiting": true
    }
  }
}
