#!/usr/bin/env bash
# Memory search helper using mem0 local-graph MCP
# Usage: memory-search [query]

set -euo pipefail

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${BLUE}[INFO]${NC} $*"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $*"; }
warning() { echo -e "${YELLOW}[WARNING]${NC} $*"; }

# Configuration
MAX_FACTS="${MEMORY_MAX_FACTS:-10}"
MAX_NODES="${MEMORY_MAX_NODES:-10}"

# Main search function
search_memories() {
  local query="$1"

  info "Searching memories for: ${query}"
  echo ""

  # Note: This requires mem0 MCP server running
  # Integration via OpenCode MCP tools:
  #   mcp__local-graph__search_memory_facts(query: "${query}", max_facts: ${MAX_FACTS})
  #   mcp__local-graph__search_nodes(query: "${query}", max_nodes: ${MAX_NODES})

  warning "Memory search requires mem0 MCP server integration"
  info "This script is a placeholder for future MCP integration"
  echo ""

  # Show example usage
  echo "To search using MCP (from agent):"
  echo "  search_memory_facts(\"${query}\")"
  echo ""
  echo "Example queries:"
  echo "  - Component: search_memory_facts(\"tandoor handlers\")"
  echo "  - Pattern: search_memory_facts(\"CrudHandler abstraction\")"
  echo "  - Bug: search_memory_facts(\"pagination bug\")"
  echo "  - Test: search_memory_facts(\"test pattern mocking\")"
  echo "  - Idiom: search_memory_facts(\"gleam idiom result\")"
  echo ""
}

# Suggest related searches
suggest_searches() {
  local query="$1"

  echo "=== Related Search Suggestions ==="
  echo ""

  # Pattern-based suggestions
  if [[ "${query}" =~ handler ]]; then
    echo "  search_memory_facts(\"CrudHandler pattern\")"
    echo "  search_memory_facts(\"tandoor architecture\")"
  fi

  if [[ "${query}" =~ bug|fix|error ]]; then
    echo "  search_memory_facts(\"bug fix\")"
    echo "  search_memory_facts(\"root cause\")"
  fi

  if [[ "${query}" =~ test ]]; then
    echo "  search_memory_facts(\"test pattern\")"
    echo "  search_memory_facts(\"mocking\")"
    echo "  search_memory_facts(\"snapshot testing\")"
  fi

  if [[ "${query}" =~ gleam|idiom ]]; then
    echo "  search_memory_facts(\"gleam idiom\")"
    echo "  search_memory_facts(\"result chaining\")"
    echo "  search_memory_facts(\"pipe operator\")"
  fi

  echo ""
}

# List all memories
list_all() {
  info "Listing all memories"
  echo ""

  warning "Requires mem0 MCP server integration"
  echo "Use: mcp__local-graph__get_episodes(max_episodes: 50)"
  echo ""
}

# Show memory statistics
show_stats() {
  info "Memory statistics"
  echo ""

  warning "Requires mem0 MCP server integration"
  echo ""
  echo "To implement:"
  echo "  1. Count total memories: get_episodes() | wc -l"
  echo "  2. Count by category: search by category tags"
  echo "  3. Recent memories: sort by timestamp"
  echo ""
}

# Main entry point
main() {
  local cmd="${1:-}"

  case "${cmd}" in
    ""|search)
      if [ -z "${2:-}" ]; then
        warning "No query provided"
        echo ""
        echo "Usage: memory-search [query]"
        echo ""
        echo "Examples:"
        echo "  memory-search 'tandoor handlers'"
        echo "  memory-search 'pagination bug'"
        echo "  memory-search 'test pattern'"
        echo ""
        exit 1
      fi

      search_memories "${2}"
      suggest_searches "${2}"
      ;;

    list)
      list_all
      ;;

    stats)
      show_stats
      ;;

    help|--help|-h)
      echo "Memory Search Tool"
      echo ""
      echo "Usage:"
      echo "  memory-search [query]         Search for memories"
      echo "  memory-search list            List all memories"
      echo "  memory-search stats           Show statistics"
      echo "  memory-search help            Show this help"
      echo ""
      echo "Environment Variables:"
      echo "  MEMORY_MAX_FACTS=${MAX_FACTS}  Max facts to return"
      echo "  MEMORY_MAX_NODES=${MAX_NODES}  Max nodes to return"
      echo ""
      echo "Examples:"
      echo "  memory-search 'tandoor handlers'"
      echo "  memory-search 'pagination bug'"
      echo "  memory-search 'test pattern mocking'"
      echo "  memory-search 'gleam idiom result'"
      echo ""
      echo "Search by:"
      echo "  - Component: 'tandoor handlers', 'auth module'"
      echo "  - Pattern: 'CrudHandler', 'pagination logic'"
      echo "  - Bug: 'pagination bug', 'mapper type error'"
      echo "  - Test: 'test pattern', 'mocking', 'snapshot'"
      echo "  - Idiom: 'gleam idiom', 'result chaining'"
      echo "  - Task: 'bd-xxx', task ID"
      echo ""
      ;;

    *)
      # Default to search
      search_memories "${cmd}"
      suggest_searches "${cmd}"
      ;;
  esac
}

main "$@"
